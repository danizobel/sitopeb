<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Peter Bun - Menu Digitale Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://gateway.sumup.com/gateway/ecom/card/v2/sdk.js"></script>
    
    <style>
        :root {
            --bg-header: #f8f5f0;
            --bg-dark: #1a0f0f; 
            --bg-choco: #3e2723;
            --accent-gold: #ffc107; 
            --text-cream: #f8f1e7;
            --text-dark: #3e2723; 
            --text-muted: #bcaaa4;
            --card-glass: rgba(62, 39, 35, 0.75);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(to bottom, var(--bg-dark), var(--bg-choco)); color: var(--text-cream); padding-bottom: 120px; min-height: 100vh; }

        /* HEADER */
        header { position: relative; text-align: center; padding: 30px 20px 70px; background: #FFF1D6 ; overflow: hidden; }
        .header-content { position: relative; z-index: 2; }
        .brand-logo { max-width: 200px; max-height: 120px; margin: 0 auto 10px; display: block; object-fit: contain; mix-blend-mode: multiply; }
        header h1 { font-size: 2.2rem; font-weight: 900; color: var(--text-dark); margin-bottom: 5px; }
        header p { font-size: 0.95rem; font-weight: 700; color: var(--text-dark); margin-bottom: 20px; }
        .choco-wave { position: absolute; bottom: -1px; left: 0; width: 100%; line-height: 0; transform: rotate(180deg); }
        .choco-wave svg { display: block; width: calc(138% + 1.3px); height: 60px; }
        .choco-wave .shape-fill { fill: var(--bg-dark); }

        /* FILTRI & MENU */
        .filters-container { display: flex; overflow-x: auto; gap: 10px; padding: 15px 20px; position: sticky; top: 0; background: rgba(26, 15, 15, 0.98); backdrop-filter: blur(10px); z-index: 100; border-bottom: 1px solid rgba(255, 193, 7, 0.1); }
        .filters-container::-webkit-scrollbar { display: none; }
        .filter-btn { background: rgba(255, 255, 255, 0.05); color: var(--text-cream); border: 1px solid rgba(255, 193, 7, 0.3); padding: 8px 18px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; white-space: nowrap; cursor: pointer; transition: all 0.3s ease; }
        .filter-btn.active { background: var(--accent-gold); color: var(--bg-dark); border-color: var(--accent-gold); box-shadow: 0 2px 10px rgba(255, 193, 7, 0.3); }
        
        .menu-container { padding: 0 15px; }
        .category-section { animation: fadeIn 0.4s ease-in-out; display: block; }
        .category-section.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .category-title { padding: 25px 5px 10px; font-size: 1.5rem; font-weight: 800; color: var(--accent-gold); text-transform: uppercase; border-bottom: 1px solid rgba(255, 193, 7, 0.2); margin-bottom: 15px; }
        
        .menu-item { background-color: var(--card-glass); backdrop-filter: blur(10px); border: 1px solid rgba(255, 193, 7, 0.15); border-radius: 16px; padding: 12px; margin: 15px 0; display: flex; flex-direction: column; }
        .item-main-content { display: flex; gap: 15px; }
        .item-image-container { flex-shrink: 0; width: 90px; height: 90px; border-radius: 12px; overflow: hidden; background-color: var(--bg-choco); border: 1px solid rgba(255,193,7,0.3); }
        .item-image { width: 100%; height: 100%; object-fit: cover; }
        .item-text-content { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; }
        .item-name { font-size: 1.1rem; font-weight: 700; color: var(--text-cream); line-height: 1.2; margin-bottom: 4px; }
        .item-price { font-size: 1.2rem; font-weight: 800; color: var(--accent-gold); margin-bottom: 6px; }
        .item-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.3; margin-bottom: 8px; }
        
        .controls { display: flex; align-items: center; justify-content: flex-end; gap: 12px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 193, 7, 0.1); }
        .btn-control { background: linear-gradient(145deg, var(--accent-gold), #ffb300); color: #3e2723; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1rem; font-weight: 800; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .qty { font-weight: 700; font-size: 1.2rem; min-width: 25px; text-align: center; }

        /* FOOTER CARRELLO */
        .cart-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(30, 20, 20, 0.98); padding: 15px 20px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 2px solid var(--accent-gold); transform: translateY(120%); transition: transform 0.3s ease; z-index: 1000; border-radius: 20px 20px 0 0; }
        .cart-footer.visible { transform: translateY(0); }
        .cart-total { font-size: 1.3rem; font-weight: 900; color: var(--accent-gold); }
        .cart-total span { display: block; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .btn-checkout { background: linear-gradient(45deg, #25D366, #128C7E); color: white; border: none; padding: 12px 20px; border-radius: 50px; font-weight: 700; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; cursor: pointer; }

        /* MODAL CHECKOUT */
        .checkout-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .checkout-modal.active { display: flex; }
        .checkout-content { background: var(--bg-choco); border: 1px solid var(--accent-gold); border-radius: 20px; padding: 25px 20px; width: 100%; max-width: 400px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position: absolute; top: 15px; right: 20px; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }
        .checkout-content h3 { color: var(--accent-gold); margin-bottom: 15px; font-weight: 800; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-cream); margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,193,7,0.3); color: var(--text-cream); outline: none; }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--accent-gold); }
        .btn-confirm-order { width: 100%; background: linear-gradient(45deg, #ffc107, #ff9800); color: #3e2723; border: none; padding: 15px; border-radius: 50px; font-size: 1.1rem; font-weight: 800; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <img src="images/logo.png" alt="Peter Bun" class="brand-logo" onerror="this.style.display='none'; document.getElementById('brand-text').style.display='block';">
            <h1 id="brand-text" style="display: none;">PETER BUN</h1>
            <p>La 1¬∞ Paninoteca Dolce d'Italia</p>
        </div>
        <div class="choco-wave"><svg viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" class="shape-fill"></path></svg></div>
    </header>

    <div class="filters-container" id="filters-container"></div>
    <div id="menu-container" class="menu-container"></div>

    <div class="cart-footer" id="cart-footer">
        <div class="cart-total"><span>Totale Ordine</span><div id="total-price">0,00 ‚Ç¨</div></div>
        <button class="btn-checkout" onclick="openCheckout()"><i class="fa-solid fa-cart-shopping"></i> Checkout</button>
    </div>

    <div class="checkout-modal" id="checkout-modal">
        <div class="checkout-content">
            <i class="fa-solid fa-xmark close-modal" onclick="closeCheckout()"></i>
            <h3>Dati di Consegna</h3>
            
            <div id="sumup-card-container" style="display: none; background: white; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                <div id="sumup-card"></div>
            </div>

            <div id="dati-cliente-form">
                <div class="form-group"><label>Nome e Cognome *</label><input type="text" id="cust-name" required></div>
				<div class="form-group">
					<label for="orario-consegna">Orario di ritiro/consegna:</label>
					<input type="time" id="orario-consegna" name="orario" required>
				</div>
                <div class="form-group"><label>Info aggiuntive</label><textarea id="cust-notes" rows="2" placeholder="Es. Citofono Rossi"></textarea></div>
				<div class="form-group"><small>*Nota: L'ordine sar√† pronto in circa 10 minuti dall'invio di questo messaggio. Non siamo responsabili per prodotti consumati freddi in caso di ritardo nel ritiro.</small>
                <button class="btn-confirm-order" onclick="sendOrderWithDetails()" id="pay-btn">
                    <i class="fa-solid fa-credit-card"></i> Paga con SumUp
                </button>
            </div>
        </div>
    </div>

    <script>
        // DATI COMPLETI DEL MENU
        const menuData = [
            {
                id: "classici",
                category: "I Classici",
                items: [
                    { id: 1, name: "Peter Bun Nutella", desc: "La classica e inimitabile crema Nutella", price: 1, image: "images/nutella.jpg" },
                    { id: 2, name: "Peter Bun Pistacchio", desc: "Crema artigianale al pistacchio", price: 4.20, image: "images/pistacchio.jpg" },
                    { id: 3, name: "Peter Bun Crema al Latte", desc: "Soffice crema al latte", price: 4.20, image: "images/latte.jpg" },
                    { id: 4, name: "Peter Bun Pan di Stelle", desc: "Crema Pan di Stelle con granella", price: 4.20, image: "images/stelle.jpg" },
                    { id: 5, name: "Peter Bun Caramello Salato", desc: "Crema al caramello salato", price: 4.20, image: "images/caramello.jpg" },
                    { id: 6, name: "Peter Bun Dubai Choc", desc: "Crema Dubai chocolate croccante", price: 4.20, image: "images/dubai.jpg" },
                    { id: 7, name: "Peter Bun Lotus", desc: "Crema biscotto Lotus Biscoff", price: 4.20, image: "images/lotus.jpg" },
                    { id: 8, name: "Peter Bun Arachidi", desc: "Crema al burro d'arachidi", price: 4.20, image: "images/arachidi.jpg" }
                ]
            },
            {
                id: "consigliati",
                category: "I Consigliati",
                items: [
                    { id: 9, name: "Peter Bun Nicolino", desc: "Crema al latte e confettura d'albicocca.", price: 5.10, image: "images/nicolino.jpg" },
                    { id: 10, name: "Peter Bun Pingu√¨", desc: "Nutella, cocco e barretta Kinder Pingu√¨", price: 6.00, image: "images/pingui.jpg" },
                    { id: 11, name: "Peter Bun Dulotus", desc: "Dubai chocolate e crema Lotus", price: 5.60, image: "images/dulotus.jpg" },
                    { id: 12, name: "Dolce e Salato", desc: "Crema Tiramis√π e Caramello Salato", price: 5.40, image: "images/dolcesalato.jpg" },
                    { id: 13, name: "Peter Bun Paradiso", desc: "Nutella, crema al latte, Kinder Paradiso", price: 5.20, image: "images/paradiso.jpg" },
                    { id: 14, name: "Men√π Tris Kinder", desc: "1 Pingu√¨, 1 Paradiso e 1 Fetta al latte.", price: 12.90, image: "images/tris.jpg" }
                ]
            },
            {
                id: "bevande",
                category: "Bevande",
                items: [
                    { id: 15, name: "Coca-Cola 33cl", desc: "In lattina", price: 2.00, image: "images/coca.jpg" },
                    { id: 16, name: "Acqua 50cl", desc: "Naturale o Frizzante in bottiglia", price: 1.30, image: "images/acqua.jpg" }
                ]
            }
        ];

        let cart = {};

        function initApp() { renderFilters(); renderMenu(); }

        function renderFilters() {
            const filterContainer = document.getElementById('filters-container');
            const btnAll = document.createElement('button'); btnAll.className = 'filter-btn active'; btnAll.innerText = 'Tutti';
            btnAll.onclick = () => filterMenu('all', btnAll); filterContainer.appendChild(btnAll);
            menuData.forEach(cat => {
                const btn = document.createElement('button'); btn.className = 'filter-btn'; btn.innerText = cat.category;
                btn.onclick = () => filterMenu(cat.id, btn); filterContainer.appendChild(btn);
            });
        }

        function filterMenu(categoryId, btnElement) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); btnElement.classList.add('active');
            document.querySelectorAll('.category-section').forEach(section => {
                if (categoryId === 'all' || section.id === `cat-${categoryId}`) section.classList.remove('hidden'); else section.classList.add('hidden');
            });
            window.scrollTo({ top: document.getElementById('filters-container').offsetTop, behavior: 'smooth' });
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            menuData.forEach(category => {
                const sectionDiv = document.createElement('div'); sectionDiv.className = 'category-section'; sectionDiv.id = `cat-${category.id}`;
                sectionDiv.innerHTML = `<h2 class="category-title">${category.category}</h2>`;
                category.items.forEach(item => {
                    sectionDiv.innerHTML += `
                        <div class="menu-item">
                            <div class="item-main-content">
                                <div class="item-image-container"><img src="${item.image}" alt="${item.name}" class="item-image" onerror="this.onerror=null; this.src='https://placehold.co/200/3e2723/ffc107?text=FOTO';"></div>
                                <div class="item-text-content">
                                    <div class="item-name">${item.name}</div>
                                    <div class="item-price">${item.price.toFixed(2).replace('.',',')}‚Ç¨</div>
                                    <p class="item-desc">${item.desc}</p>
                                </div>
                            </div>
                            <div class="controls">
                                <button class="btn-control" onclick="updateQty(${item.id}, -1)"><i class="fa-solid fa-minus"></i></button>
                                <span class="qty" id="qty-${item.id}">0</span>
                                <button class="btn-control" onclick="updateQty(${item.id}, 1)"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>`;
                });
                container.appendChild(sectionDiv);
            });
        }

        function updateQty(itemId, change) {
            if (!cart[itemId]) cart[itemId] = 0; cart[itemId] += change; if (cart[itemId] < 0) cart[itemId] = 0;
            document.getElementById(`qty-${itemId}`).innerText = cart[itemId]; updateCartUI();
        }

        function updateCartUI() {
            let total = 0, totalItems = 0;
            menuData.forEach(category => category.items.forEach(item => {
                if (cart[item.id]) { total += item.price * cart[item.id]; totalItems += cart[item.id]; }
            }));
            document.getElementById('total-price').innerText = total.toFixed(2).replace('.',',') + ' ‚Ç¨';
            const footer = document.getElementById('cart-footer');
            if (totalItems > 0) footer.classList.add('visible'); else footer.classList.remove('visible');
        }

        function openCheckout() { 
            // Mostra sempre il form dati cliente all'apertura
            document.getElementById('dati-cliente-form').style.display = 'block';
            document.getElementById('sumup-card-container').style.display = 'none';
            document.getElementById('checkout-modal').classList.add('active'); 
        }
        function closeCheckout() { document.getElementById('checkout-modal').classList.remove('active'); }
// INVIO A SUMUP E SALVATAGGIO IN MEMORIA
        async function sendOrderWithDetails() {
            const name = document.getElementById('cust-name').value.trim();
			const orario = document.getElementById('orario-consegna').value; // Recupera l'orario
            const notes = document.getElementById('cust-notes').value.trim();

            if(!name) { alert("Compila Nome per la consegna!"); return; }

            // GENERATORE CODICE ORDINE UNIVOCO
            const cleanName = name.replace(/\s+/g, '').toUpperCase(); 
            const firstLetter = cleanName.charAt(0) || 'P';
            const lastLetter = cleanName.charAt(cleanName.length - 1) || 'B';
            const randomNum = Math.floor(10000 + Math.random() * 90000);
            const orderId = `PB-${firstLetter}${lastLetter}-${randomNum}`;

            let cartItems = []; let total = 0; 
            let text = `*NUOVO ORDINE DELIVERY!* üç©%0AüÜî *Rif:* ${orderId}%0A%0Aüë§ *Cliente:* ${name}%0Aüìç *Orario:* ${orario}%0A`;
            if(notes) text += `üìù *Note:* ${notes}%0A`; 
            text += `%0A*RIEPILOGO ORDINE:*%0A`;

            menuData.forEach(category => category.items.forEach(item => {
                if (cart[item.id] > 0) {
                    cartItems.push({ name: item.name, price: item.price, qty: cart[item.id] });
                    const lineTotal = item.price * cart[item.id]; total += lineTotal;
                    text += `‚ñ´Ô∏è ${cart[item.id]}x ${item.name} (${lineTotal.toFixed(2)}‚Ç¨)%0A`;
                }
            }));

            // BLOCCO DI SICUREZZA SUMUP (Minimo 1 euro)
            if (total < 1.00) {
                alert("Attenzione: L'ordine minimo per pagare con SumUp √® 1.00 ‚Ç¨! Aggiungi altri prodotti.");
                return;
            }

            text += `%0Aüí∞ *TOTALE PAGATO CON SUMUP: ${total.toFixed(2)} ‚Ç¨*%0A`;
			text += `‚ö†Ô∏è *Nota:* L'ordine sar√† pronto in circa 10 minuti dall'invio di questo messaggio. Non siamo responsabili per prodotti consumati freddi in caso di ritardo nel ritiro.`;
            localStorage.setItem('peterbun_order_message', text);

            const btn = document.getElementById('pay-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Collegamento SumUp...'; btn.disabled = true;

            const WORKER_URL = "/paga";

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: cartItems })
                });
                const data = await response.json();
                
                if (data.checkoutId) { 
                    document.getElementById('dati-cliente-form').style.display = 'none';
                    document.getElementById('sumup-card-container').style.display = 'block';
                    
                    // Avvia il widget SumUp con Apple Pay e Google Pay inclusi
                    SumUpCard.mount({
                        id: 'sumup-card',
                        checkoutId: data.checkoutId,
                        
                        // üü¢ CONFIGURAZIONE GOOGLE PAY
                        googlePay: {
                            // Sostituisci questo con il VERO ID fornito da Google al cliente
                            merchantId: 'INSERISCI_ID_GOOGLE_QUI', 
                            merchantName: 'Peter Bun'
                        },
                        
                        // üçé CONFIGURAZIONE APPLE PAY
                        applePay: {
                            merchantName: 'Peter Bun'
                        },

                        onResponse: function(type, body) {
                            // 1. La transazione √® andata a buon fine E i soldi sono stati prelevati
                            if (type === 'success' && body.status === 'PAID') {
                                window.location.href = "successo.html";
                            } 
                            // 2. La comunicazione √® andata bene, MA la banca ha rifiutato la carta (es. zero fondi)
                            else if (type === 'success' && body.status === 'FAILED') {
                                alert("Transazione negata dalla banca. Verifica il saldo o i dati della carta e riprova.");
                                window.location.href = "errore.html";
                            } 
                            // 3. Errori tecnici vari del sistema
                            else if (type === 'error' || type === 'fail' || type === 'declined') {
                                alert("Errore durante il pagamento:\n" + JSON.stringify(body));
                                window.location.href = "errore.html";
                            }
                            // 4. Se type √® 'sent', il codice lo ignora e lascia girare la rotellina in attesa
                        }
                    });
                } else { 
                    // ‚ö†Ô∏è LA MAGIA: QUESTO ALERT CI DIRA' LA VERITA' SULL'ERRORE! ‚ö†Ô∏è
                    alert("ERRORE DI SUMUP:\n" + JSON.stringify(data, null, 2)); 
                    btn.innerHTML = '<i class="fa-solid fa-credit-card"></i> Paga con SumUp'; 
                    btn.disabled = false; 
                }
            } catch (error) {
                alert("Errore di connessione al server:\n" + error.message); 
                btn.innerHTML = '<i class="fa-solid fa-credit-card"></i> Paga con SumUp'; 
                btn.disabled = false;
            }
        }
		window.addEventListener('load', () => {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('orario-consegna').value = `${hours}:${minutes}`;
		});
        window.onload = initApp;
    </script>
</body>
</html>